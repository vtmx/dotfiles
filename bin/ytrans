#!/usr/bin/env bash

# Youtube download transcript

set -e

yt_trans_file=transcript.pt.srt
yt_trans_file_format=transcript.txt
yt_trans_lang=pt

# Check file exist
if [[ -f "$yt_trans_file" ]]; then
  read -rp 'File exist overwrie [y/N]: ' opc

  if [[ $opc =~ [Yy] ]]; then
    yt_trans_file_overwrite=true
  fi
fi

# Check url
if [[ $1 ]]; then
  yt_url="$1"
else
  echo 'error: need url' >&2
  exit 1
fi

# Check yt-dlp
if ! type yt-dlp  >/dev/null; then
  echo 'error: need yt-dlp' >&2
  exit 1
fi

# Get transcript
if [[ $yt_trans_file_overwrite ]]; then
  yt-dlp \
    --skip-download \
    --sub-format srt \
    --sub-lang $yt_trans_lang \
    --write-subs \
    --write-auto-subs \
    --quiet \
    --output "transcript" \
    "$yt_url"  
fi

# Get format transcript from
yt_trans_txt=$(awk -f format.awk "$yt_trans_file")

read -rp '
Escolha uma opção:
p) Print
o) Open
g) Gui
s) Save
q) Quit

Opção: ' opc

case "$opc" in
  p) echo "$yt_trans_txt" ;;
  o) echo "$yt_trans_txt" > "$yt_trans_file_format" && \
     $EDITOR $yt_trans_file_format
     ;;
  g) 
    if type yad  >/dev/null; then
      ./gui "$yt_trans_file"
    else
      echo 'error: need yad to gui' >&2
      exit 1
    fi
    ;;
  s) echo "$yt_trans_txt" > "$yt_trans_file_format" ;;
  q) exit 0 ;;
esac
