#!/usr/bin/env bash

# Youtube download mp3

# Used to remove repetitives dashes
shopt -s extglob

main() {
  if ! command -v yt-dlp &>/dev/null ; then 
    echo 'yt-dlp not found'
    exit 127
  fi

  local url=""
  local filename=""
  local time_start=""
  local time_end=""
  local filename=""

  while (( $# )); do
    case "$1" in
      *youtu*)
        [[ -z "$url" ]] && url="$1"
        shift
        ;;
      # time: 1:23, 01:30, 0:45
      *([0-9]):*([0-9]) | *([0-9]):*([0-9]):*([0-9]) | [0-9][0-9]?:[0-9][0-9] | [0-9]:[0-9][0-9] | [0-9][0-9][0-9])
        if [[ -z "$time_start" ]]; then
          time_start="$1"
        elif [[ -z "$time_end" ]]; then
          time_end="$1"
        fi
        shift
        ;;
      *)
        filename+="$1"
        shift
        ;;
    esac
  done

  # Get title of video
  if [[ -z "$filename" ]]; then
    filename=$(yt-dlp --print filename -o "%(title)s" "$url")
  fi

  # Transform filename
  filename=$(transform_filename "$filename")

  # Download file
  local args=(
    -x
    --add-metadata
    --audio-format mp3
    --embed-thumbnail
    --no-warnings
    -o "$filename"
    "$url"
  )

  # Add arg --download-sections if time fill
  if [[ -n "$time_start" ]]; then
    if [[ -n "$time_end" ]]; then
      args+=(--download-sections "*${time_start}-${time_end}")
    else
      args+=(--download-sections "*0:00-${time_start}")
    fi
  fi

  # Command
  yt-dlp "${args[@]}"
}

transform_filename() {
  # Remove chars
  filename="${filename//[\'\"\“\”\[\]\(\)\/\⧸]/}"

  # Replace spaces with dashes
  filename="${filename// /-}"

  # Replace repetitives dashes for one
  filename="${filename//+(-)/-}"

  # Convert to lowercase
  filename="${filename,,}"

  echo "$filename"
}

main "$@"
