#!/usr/bin/env bash

set -e

# awk '/wp-manga-chapter-img">$/ {print $0}' site.url
# wget $(curl 'site' | grep -Eo 'https://mangalivre.to/wp-content/uploads/WP-manga/data.+.webp')
# curl 'site' | grep -Eo 'https://mangalivre.to/wp-content/uploads/WP-manga/data.+.webp' | xargs wget
# https://mangalivre.to/manga/kimetsu-no-yaiba/capitulo-{1..150}/

url_base='https://mangalivre.to'
manga_title='kimetsu-no-yaiba'
chapter_start=23
chapter_end=25
echo

# Download imagens
for ((chapter=$chapter_start; chapter<=$chapter_end; chapter++)); do
  chapter_number=$(printf "%03d" $chapter) 
  manga_dir="$(pwd)/$manga_title"
  chapter_dir="$manga_dir/$chapter_number"

  echo "Create dir $(pwd)/$chapter_dir"
  [[ -d "$chapter_dir" ]] && rm -r "$chapter_dir"
  mkdir -p "$chapter_dir"

  manga_url="$url_base/manga/$manga_title/capitulo-${chapter}/"
  echo -e "Download fom: $manga_url\nTo: $(pwd)/$chapter_dir"
  wget -q -P "$chapter_dir" \
  $(curl "$manga_url" | grep -Eo "$url_base/wp-content/uploads/WP-manga/data.+.webp")

  echo 'Converting webp to html...'
  manga_file_html="$manga_dir/$manga_title-$chapter_number.html"
  manga_file_mobi="$manga_dir/$manga_title-$chapter_number.mobi"
  echo -e "<html>\n\t<body style=\"background: black\">" > "$manga_file_html"
  for img in "$chapter_dir"/*.webp; do
    echo -e "\t\t<img style=\"display: block; margin: 0 auto; width: 100%; height: auto\" src=\"$img\">" >> "$manga_file_html"
  done
  echo -e "\t</body>\n</html>" >> "$manga_file_html"

  echo Convert cover image...
  manga_cover_webp=$(ls $chapter_dir/*.webp | head -n1)
  manga_cover_png="${manga_cover_webp/webp/png}"
  magick "$manga_cover_webp" "$manga_cover_png"

  echo 'Converting to html to mobi...'
  ebook-convert "$manga_file_html" "$manga_file_mobi" \
  --title "$manga_title-$chapter_number" \
  --authors "Mangá Livre" \
  --publisher "Mangá Livre" \
  --language "pt_BR" \
  --cover "$manga_cover_png" \
  --extra-css "style.css"

  echo "Removing $manga_file_html"
  rm "$manga_file_html"

  echo "Removing dir $chapter_dir"
  rm -r "$chapter_dir"
done
