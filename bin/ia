#!/usr/bin/env bash

# Check ia key
if [[ -f $HOME/.groq.key ]]; then
  iakey=$(<$HOME/.groq.key)
else
  echo 'error: need apikey in ~/.groq.key'
  exit 1
fi

# Check prereq
prereqs=(curl glow gum jq)
if ! type "${prereqs[@]}" &>/dev/null; then
  echo 'error: need curl, gum, glow and jq'
  exit 1
fi

# Get msg
if [[ "$*" ]]; then
  msg="$*"
else
  echo 'error: no message'
  exit 1
fi

# Vars
api_url="https://api.groq.com/openai/v1/chat/completions"
auth_header="Bearer $iakey"
content_type="application/json"
role="user"
model="llama-3.3-70b-versatile"
premsg="Escreva sem enrolação o mais resumidamente e direto possível."

curl -s -X POST "$api_url" \
  -H "Authorization: $auth_header" \
  -H "Content-Type: $content_type" \
  -d '{
    "messages": [
      {
        "role": "'"$role"'",
        "content": "'"$premsg $msg"'"
      }
    ],
    "model": "'"$model"'"
  }' | \
jq -r '.choices[0].message.content' | \
glow -s "$HOME/.config/glow/onedark.json"
